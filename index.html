<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mensajer√≠a WHA - Municipio de Lomas de Zamora</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: linear-gradient(135deg, #2C7A9B 0%, #4BA3C7 50%, #87CEEB 100%);
            min-height: 100vh;
            padding: 0;
        }
        
        .navbar {
            background: #2C7A9B;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2C7A9B;
            font-size: 1.2rem;
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-title {
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.2;
        }
        
        .logo-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .nav-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .page-title {
            color: #2C7A9B;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .page-header .update-time {
            color: #15803d;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .update-time {
            color: #15803d;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .dashboard {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(44, 122, 155, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(44, 122, 155, 0.2);
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #2C7A9B, #4BA3C7);
            color: white;
            text-align: center;
            padding: 25px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(44, 122, 155, 0.3);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .kpi-card:hover::before {
            transform: translateX(100%);
        }
        
        .kpi-card:hover {
            transform: translateY(-3px) scale(1.02);
        }
        
        .kpi-value {
            font-size: 2.8rem;
            font-weight: bold;
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }
        
        .kpi-label {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #2C7A9B;
            text-align: center;
            border-bottom: 2px solid #E6F3FF;
            padding-bottom: 15px;
        }
        
        .status-success { 
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .status-error { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .status-queue { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        .status-total { 
            background: linear-gradient(135deg, #2C7A9B, #4BA3C7);
        }
        .status-rate { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        .status-processed { 
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 300px;
            font-size: 1.2rem;
            color: #2C7A9B;
        }
        
        .error {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: #b91c1c;
            grid-column: 1 / -1;
        }
        
        .success-alert {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 2px solid #bbf7d0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: #15803d;
            grid-column: 1 / -1;
            box-shadow: 0 4px 15px rgba(21, 128, 61, 0.1);
        }
        
        .warning-alert {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: #92400e;
            grid-column: 1 / -1;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.1);
        }
        
        .spinner {
            border: 4px solid #E6F3FF;
            border-top: 4px solid #2C7A9B;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .alert-content {
            display: flex;
            align-items: center;
        }
        
        .instancia-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .instancia-chart {
            background: rgba(44, 122, 155, 0.05);
            border-radius: 10px;
            padding: 15px;
        }
        
        .instancia-title {
            color: #2C7A9B;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .instancia-chart-container {
            height: 300px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .navbar {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .logo-section {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .page-title {
                font-size: 2rem;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .instancia-charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo-section">
            <div class="logo">LZ</div>
            <div class="logo-text">
                <div class="logo-title">Municipio Lomas de Zamora</div>
                <div class="logo-subtitle">Gobierno de la Comunidad</div>
            </div>
        </div>
        <div class="nav-actions">
            <div class="update-time" id="updateTime">Cargando...</div>
            <button class="refresh-btn" onclick="loadData()">
                üîÑ Actualizar
            </button>
        </div>
    </nav>

    <!-- Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">üì± Dashboard Mensajer√≠a WHA</h1>
            <p class="page-subtitle">Sistema de Monitoreo de Comunicaciones Masivas</p>
            <div class="update-time">Datos actualizados en tiempo real desde Google Sheets</div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard" id="dashboard">
            <!-- Loading State -->
            <div class="card loading" id="loading" style="grid-column: 1 / -1;">
                <div class="spinner"></div>
                <div>Conectando con el sistema de mensajer√≠a...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const SHEET_ID = '1qTmFunrbfVWlG7EMTnGYrdeMbJxNt5DkEK8aE80jC2s';
        const SHEET_NAME = 'Estado_envios';
        const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
        
        let charts = {};
        let rawData = [];
        
        // Configuraci√≥n global de Chart.js con colores de Lomas
        Chart.defaults.font.family = 'Segoe UI';
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.color = '#2C7A9B';
        
        async function loadData() {
            try {
                showLoading();
                
                const response = await fetch(API_URL);
                const text = await response.text();
                
                // Google Sheets devuelve JSONP, necesitamos extraer el JSON
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                if (!json.table || !json.table.rows) {
                    throw new Error('No se encontraron datos en la hoja Estado_envios');
                }
                
                // Procesar datos
                rawData = processGoogleSheetsData(json);
                
                // Crear dashboard
                createDashboard(rawData);
                
                // Actualizar tiempo
                updateTime();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showError(error.message);
            }
        }
        
        function processGoogleSheetsData(json) {
            const cols = json.table.cols;
            const rows = json.table.rows;
            
            return rows.map(row => {
                const obj = {};
                cols.forEach((col, index) => {
                    const cell = row.c[index];
                    let value = cell ? cell.v : null;
                    
                    // Manejar fechas espec√≠ficamente
                    if (col.label === 'timestamp_envio' && value) {
                        if (typeof value === 'object' && value.toString) {
                            // Si es un objeto Date, usar tal como est√° (ya est√° en hora local)
                            obj[col.label] = value;
                        } else if (typeof value === 'string') {
                            // Si es string, limpiar y procesar
                            value = value.replace(/"/g, '').replace(/\n/g, '').trim();
                            if (value && value !== 'null') {
                                obj[col.label] = value;
                            }
                        }
                    } else {
                        obj[col.label] = value;
                    }
                });
                return obj;
            });
        }
        
        function createDashboard(data) {
            // An√°lisis de datos
            const analysis = analyzeData(data);
            
            // Crear contenido del dashboard
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                ${createAlert(analysis)}
                ${createKPIs(analysis)}
                ${createCharts(analysis)}
            `;
            
            // Renderizar gr√°ficos
            renderCharts(analysis);
        }
        
        function analyzeData(data) {
            console.log("=== INICIO AN√ÅLISIS DE DATOS ===");
            console.log("Total de registros recibidos:", data.length);
            
            const total = data.length;
            const procesados = data.filter(row => row.Estado !== 'en_cola');
            const enCola = data.filter(row => row.Estado === 'en_cola');
            const exitosos = data.filter(row => row.rta_api === 201);
            const conError = procesados.filter(row => row.rta_api !== 201);
            
            console.log("Procesados:", procesados.length);
            console.log("En cola:", enCola.length);
            console.log("Exitosos:", exitosos.length);
            console.log("Con error:", conError.length);
            
            // An√°lisis de c√≥digos de error
            const codigosError = {};
            conError.forEach(row => {
                const codigo = row.rta_api || 'Sin c√≥digo';
                codigosError[codigo] = (codigosError[codigo] || 0) + 1;
            });
            
            // An√°lisis por instancia
            const instancias = {};
            procesados.forEach(row => {
                if (row.Instancia) {
                    instancias[row.Instancia] = (instancias[row.Instancia] || 0) + 1;
                }
            });
            
            console.log("=== DEBUG TIMESTAMPS ===");
            console.log("Muestras de timestamp_envio:");
            data.slice(0, 5).forEach((row, i) => {
                console.log(`Fila ${i+1}: "${row.timestamp_envio}" (tipo: ${typeof row.timestamp_envio})`);
            });
            
            // An√°lisis temporal total con intervalos de 15 minutos
            console.log("=== PROCESANDO TEMPORAL TOTAL ===");
            const temporal = {};
            let temporalCount = 0;
            let validDates = 0;
            let todayDates = 0;
            let minDate = null;
            let maxDate = null;
            
            // Primero encontrar el rango de fechas (m√°s viejo a m√°s nuevo)
            data.forEach((row, index) => {
                if (row.timestamp_envio) {
                    let date;
                    
                    try {
                        if (typeof row.timestamp_envio === 'object' && row.timestamp_envio instanceof Date) {
                            date = new Date(row.timestamp_envio);
                        } else if (typeof row.timestamp_envio === 'string') {
                            let dateString = row.timestamp_envio
                                .replace(/"/g, '')
                                .replace(/\n/g, '')
                                .replace(/\r/g, '')
                                .trim();
                            
                            if (!dateString || dateString === 'null') return;
                            
                            if (dateString.includes('T') && dateString.endsWith('Z')) {
                                const localDateString = dateString.replace('Z', '');
                                date = new Date(localDateString);
                            } else {
                                date = new Date(dateString);
                            }
                        } else {
                            return;
                        }
                        
                        if (isNaN(date.getTime())) return;
                        
                        const today = new Date();
                        const isToday = date.toDateString() === today.toDateString();
                        
                        if (isToday) {
                            if (!minDate || date < minDate) minDate = date;
                            if (!maxDate || date > maxDate) maxDate = date;
                        }
                    } catch (error) {
                        // Silencioso en primera pasada
                    }
                }
            });
            
            // Usar hora actual como m√°ximo si es mayor que el √∫ltimo timestamp
            const now = new Date();
            if (!maxDate || now > maxDate) maxDate = now;
            
            console.log(`Rango temporal: ${minDate} hasta ${maxDate}`);
            
            // Ahora procesar los datos dentro del rango completo
            data.forEach((row, index) => {
                if (row.timestamp_envio) {
                    temporalCount++;
                    let date;
                    
                    try {
                        if (typeof row.timestamp_envio === 'object' && row.timestamp_envio instanceof Date) {
                            console.log(`Fila ${index+1}: Es objeto Date - ${row.timestamp_envio}`);
                            date = new Date(row.timestamp_envio);
                        } else if (typeof row.timestamp_envio === 'string') {
                            let dateString = row.timestamp_envio
                                .replace(/"/g, '')
                                .replace(/\n/g, '')
                                .replace(/\r/g, '')
                                .trim();
                            
                            if (!dateString || dateString === 'null') {
                                console.log(`Fila ${index+1}: String vac√≠o o null`);
                                return;
                            }
                            
                            if (index < 3) console.log(`Fila ${index+1}: String limpio - "${dateString}"`);
                            
                            if (dateString.includes('T') && dateString.endsWith('Z')) {
                                // El timestamp YA est√° en hora Argentina correcta
                                // Remover la Z y parsearlo como hora local
                                const localDateString = dateString.replace('Z', '');
                                date = new Date(localDateString);
                                if (index < 3) console.log(`Fila ${index+1}: Timestamp local directo - ${date}`);
                            } else {
                                date = new Date(dateString);
                                if (index < 3) console.log(`Fila ${index+1}: Fecha directa - ${date}`);
                            }
                        } else {
                            console.log(`Fila ${index+1}: Tipo no soportado - ${typeof row.timestamp_envio}`);
                            return;
                        }
                        
                        if (isNaN(date.getTime())) {
                            console.log(`Fila ${index+1}: Fecha inv√°lida`);
                            return;
                        }
                        
                        validDates++;
                        
                        const today = new Date();
                        const isToday = date.toDateString() === today.toDateString();
                        
                        if (index < 3) {
                            console.log(`Fila ${index+1}: Fecha v√°lida - ${date.toDateString()}`);
                            console.log(`Fila ${index+1}: Hoy es - ${today.toDateString()}`);
                            console.log(`Fila ${index+1}: Es hoy? - ${isToday}`);
                        }
                        
                        if (isToday) {
                            todayDates++;
                            const hour = date.getHours();
                            const minute = date.getMinutes();
                            
                            if (index < 3) {
                                console.log(`Fila ${index+1}: Hora ${hour}:${minute}`);
                            }
                            
                            // Calcular intervalo de 15 minutos
                            const interval = Math.floor(minute / 15) * 15;
                            const key = `${hour.toString().padStart(2, '0')}:${interval.toString().padStart(2, '0')}`;
                            temporal[key] = (temporal[key] || 0) + 1;
                            
                            if (index < 3) {
                                console.log(`Fila ${index+1}: Intervalo ${key}, total: ${temporal[key]}`);
                            }
                        }
                    } catch (error) {
                        console.log(`Fila ${index+1}: Error procesando timestamp:`, error);
                    }
                }
            });
            
            console.log(`Total timestamps encontrados: ${temporalCount}`);
            console.log(`Fechas v√°lidas: ${validDates}`);
            console.log(`Fechas de hoy: ${todayDates}`);
            console.log("Intervalos temporales generados:", Object.keys(temporal).length);
            console.log("Datos temporales:", temporal);
            
            // Generar intervalos completos desde minDate hasta maxDate (hora actual)
            const temporalCompleto = {};
            if (minDate && maxDate) {
                const startHour = minDate.getHours();
                const startMinute = Math.floor(minDate.getMinutes() / 15) * 15;
                const endHour = maxDate.getHours();
                const endMinute = Math.floor(maxDate.getMinutes() / 15) * 15;
                
                console.log(`Generando intervalos desde ${startHour}:${startMinute} hasta ${endHour}:${endMinute}`);
                
                let currentHour = startHour;
                let currentMinute = startMinute;
                
                while (currentHour < endHour || (currentHour === endHour && currentMinute <= endMinute)) {
                    const key = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
                    temporalCompleto[key] = temporal[key] || 0;
                    
                    currentMinute += 15;
                    if (currentMinute >= 60) {
                        currentMinute = 0;
                        currentHour++;
                    }
                }
            }
            
            console.log("Temporal completo generado:", temporalCompleto);
            
            // An√°lisis temporal por instancia con intervalos de 15 minutos
            console.log("=== PROCESANDO TEMPORAL POR INSTANCIA ===");
            const temporalPorInstancia = {};
            
            data.forEach((row, index) => {
                if (row.timestamp_envio && row.Instancia) {
                    let date;
                    
                    try {
                        if (typeof row.timestamp_envio === 'object' && row.timestamp_envio instanceof Date) {
                            date = new Date(row.timestamp_envio);
                        } else if (typeof row.timestamp_envio === 'string') {
                            let dateString = row.timestamp_envio
                                .replace(/"/g, '')
                                .replace(/\n/g, '')
                                .replace(/\r/g, '')
                                .trim();
                            
                            if (!dateString || dateString === 'null') return;
                            
                            if (dateString.includes('T') && dateString.endsWith('Z')) {
                                // El timestamp YA est√° en hora Argentina correcta
                                // Remover la Z y parsearlo como hora local
                                const localDateString = dateString.replace('Z', '');
                                date = new Date(localDateString);
                            } else {
                                date = new Date(dateString);
                            }
                        } else {
                            return;
                        }
                        
                        if (isNaN(date.getTime())) return;
                        
                        const today = new Date();
                        const isToday = date.toDateString() === today.toDateString();
                        
                        if (isToday) {
                            const hour = date.getHours();
                            const minute = date.getMinutes();
                            
                            // Calcular intervalo de 15 minutos
                            const interval = Math.floor(minute / 15) * 15;
                            const key = `${hour.toString().padStart(2, '0')}:${interval.toString().padStart(2, '0')}`;
                            const instancia = row.Instancia;
                            
                            if (!temporalPorInstancia[instancia]) {
                                temporalPorInstancia[instancia] = {};
                            }
                            temporalPorInstancia[instancia][key] = (temporalPorInstancia[instancia][key] || 0) + 1;
                        }
                    } catch (error) {
                        console.log('Error procesando timestamp por instancia:', row.timestamp_envio, error);
                    }
                }
            });
            
            console.log("Temporal por instancia:", temporalPorInstancia);
            
            // Generar temporal completo para cada instancia
            const temporalPorInstanciaCompleto = {};
            if (minDate && maxDate) {
                Object.keys(temporalPorInstancia).forEach(instancia => {
                    temporalPorInstanciaCompleto[instancia] = {};
                    
                    const startHour = minDate.getHours();
                    const startMinute = Math.floor(minDate.getMinutes() / 15) * 15;
                    const endHour = maxDate.getHours();
                    const endMinute = Math.floor(maxDate.getMinutes() / 15) * 15;
                    
                    let currentHour = startHour;
                    let currentMinute = startMinute;
                    
                    while (currentHour < endHour || (currentHour === endHour && currentMinute <= endMinute)) {
                        const key = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
                        temporalPorInstanciaCompleto[instancia][key] = temporalPorInstancia[instancia][key] || 0;
                        
                        currentMinute += 15;
                        if (currentMinute >= 60) {
                            currentMinute = 0;
                            currentHour++;
                        }
                    }
                });
            }
            
            console.log("Temporal por instancia completo:", temporalPorInstanciaCompleto);
            console.log("=== FIN AN√ÅLISIS ===");
            
            // Funci√≥n para detectar ca√≠das del sistema
            function detectarCaidas(temporalCompleto, temporalPorInstancia) {
                const ahora = new Date();
                const ultimosIntervalos = [];
                
                // Generar √∫ltimos 3 intervalos de 15min
                for(let i = 2; i >= 0; i--) {
                    const tiempo = new Date(ahora.getTime() - (i * 15 * 60 * 1000));
                    const hora = tiempo.getHours();
                    const minuto = Math.floor(tiempo.getMinutes() / 15) * 15;
                    ultimosIntervalos.push(`${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`);
                }
                
                console.log("√öltimos intervalos para an√°lisis:", ultimosIntervalos);
                
                // Verificar si todo el sistema est√° ca√≠do
                const actividadSistema = ultimosIntervalos.map(intervalo => temporalCompleto[intervalo] || 0);
                const sistemaCompleto = actividadSistema.every(actividad => actividad === 0);
                
                // Encontrar desde cu√°ndo est√° ca√≠do el sistema
                let sistemaCaidoDesde = null;
                if (sistemaCompleto) {
                    const intervalosOrdenados = Object.keys(temporalCompleto).sort();
                    for (let i = intervalosOrdenados.length - 1; i >= 0; i--) {
                        if (temporalCompleto[intervalosOrdenados[i]] > 0) {
                            sistemaCaidoDesde = intervalosOrdenados[i + 1] || intervalosOrdenados[i];
                            break;
                        }
                    }
                }
                
                // Verificar instancias individuales ca√≠das
                const instanciasCaidas = [];
                Object.keys(temporalPorInstancia).forEach(instancia => {
                    const actividadInstancia = ultimosIntervalos.map(intervalo => 
                        temporalPorInstancia[instancia][intervalo] || 0
                    );
                    const instanciaCaida = actividadInstancia.every(actividad => actividad === 0);
                    
                    if (instanciaCaida && !sistemaCompleto) {
                        // Encontrar desde cu√°ndo est√° ca√≠da esta instancia
                        const intervalosInstancia = Object.keys(temporalPorInstancia[instancia]).sort();
                        let instanciaCaidaDesde = null;
                        for (let i = intervalosInstancia.length - 1; i >= 0; i--) {
                            if (temporalPorInstancia[instancia][intervalosInstancia[i]] > 0) {
                                instanciaCaidaDesde = intervalosInstancia[i + 1] || intervalosInstancia[i];
                                break;
                            }
                        }
                        instanciasCaidas.push({
                            nombre: instancia,
                            desde: instanciaCaidaDesde
                        });
                    }
                });
                
                console.log("An√°lisis de ca√≠das:", { sistemaCompleto, sistemaCaidoDesde, instanciasCaidas });
                
                return { 
                    sistemaCompleto, 
                    sistemaCaidoDesde,
                    instanciasCaidas,
                    ultimosIntervalos
                };
            }

            const analisisCaidas = detectarCaidas(temporalCompleto, temporalPorInstanciaCompleto);

            return {
                total,
                procesados: procesados.length,
                enCola: enCola.length,
                exitosos: exitosos.length,
                conError: conError.length,
                tasaExito: procesados.length > 0 ? (exitosos.length / procesados.length * 100).toFixed(2) : 0,
                codigosError,
                instancias,
                temporal: temporalCompleto,
                temporalPorInstancia: temporalPorInstanciaCompleto,
                caidas: analisisCaidas
            };
        }
        
        function createAlert(analysis) {
            const tasaExito = parseFloat(analysis.tasaExito);
            const porcentajeProcesamiento = ((analysis.procesados / analysis.total) * 100).toFixed(2);
            
            if (tasaExito >= 80) {
                return `
                    <div class="success-alert">
                        <div class="alert-content">
                            <span class="alert-icon">‚úÖ</span>
                            <div>
                                <strong>Sistema funcionando correctamente</strong><br>
                                ${porcentajeProcesamiento}% de mensajes procesados (${analysis.procesados} de ${analysis.total}). 
                                ${analysis.enCola} mensajes en cola de procesamiento.
                            </div>
                        </div>
                    </div>
                `;
            } else if (tasaExito >= 60) {
                return `
                    <div class="warning-alert">
                        <div class="alert-content">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div>
                                <strong>Atenci√≥n: Rendimiento moderado</strong><br>
                                ${porcentajeProcesamiento}% de mensajes procesados. Tasa de √©xito del ${analysis.tasaExito}%. Se recomienda revisar errores recurrentes.
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="error">
                        <div class="alert-content">
                            <span class="alert-icon">üö®</span>
                            <div>
                                <strong>Alerta: Baja tasa de √©xito</strong><br>
                                ${porcentajeProcesamiento}% de mensajes procesados. Solo ${analysis.tasaExito}% de √©xito. Es necesario revisar la configuraci√≥n del sistema urgentemente.
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function createKPIs(analysis) {
            return `
                <div class="kpi-grid">
                    <div class="kpi-card status-total">
                        <div class="kpi-value">${analysis.total}</div>
                        <div class="kpi-label">Total Mensajes</div>
                    </div>
                    <div class="kpi-card status-processed">
                        <div class="kpi-value">${analysis.procesados}</div>
                        <div class="kpi-label">Mensajes Procesados</div>
                    </div>
                    <div class="kpi-card status-success">
                        <div class="kpi-value">${analysis.exitosos}</div>
                        <div class="kpi-label">Mensajes Exitosos</div>
                    </div>
                    <div class="kpi-card status-error">
                        <div class="kpi-value">${analysis.conError}</div>
                        <div class="kpi-label">Mensajes con Error</div>
                    </div>
                    <div class="kpi-card status-queue">
                        <div class="kpi-value">${analysis.enCola}</div>
                        <div class="kpi-label">Mensajes en Cola</div>
                    </div>
                    <div class="kpi-card status-rate">
                        <div class="kpi-value">${analysis.tasaExito}%</div>
                        <div class="kpi-label">Tasa de √âxito</div>
                    </div>
                </div>
            `;
        }
        
        function createCharts(analysis) {
            let chartsHTML = `
                <div class="card">
                    <div class="chart-title">Estado de Procesamiento</div>
                    <div class="chart-container">
                        <canvas id="estadosChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-title">C√≥digos de Respuesta API</div>
                    <div class="chart-container">
                        <canvas id="codigosChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-title">Distribuci√≥n por Instancia</div>
                    <div class="chart-container">
                        <canvas id="instanciasChart"></canvas>
                    </div>
                </div>
                
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="chart-title">üìä Actividad de Env√≠os por Intervalos de 15 Minutos (Total)</div>
                    <div class="chart-container">
                        <canvas id="temporalChart"></canvas>
                    </div>
                </div>
            `;
            
            // Obtener instancias √∫nicas y agregar gr√°ficos por instancia
            const instanciasUnicas = Object.keys(analysis.instancias).filter(inst => inst && inst !== 'null').sort();
            
            if (instanciasUnicas.length > 0) {
                chartsHTML += `
                    <div class="card" style="grid-column: 1 / -1;">
                        <div class="chart-title">üìà Actividad por Instancia Individual (Intervalos de 15 min)</div>
                        <div class="instancia-charts">
                `;
                
                instanciasUnicas.forEach(instancia => {
                    chartsHTML += `
                        <div class="instancia-chart">
                            <div class="instancia-title">üîπ ${instancia.charAt(0).toUpperCase() + instancia.slice(1)}</div>
                            <div class="instancia-chart-container">
                                <canvas id="temporal_${instancia}"></canvas>
                            </div>
                        </div>
                    `;
                });
                
                chartsHTML += `
                        </div>
                    </div>
                `;
            }
            
            return chartsHTML;
        }
        
        function renderCharts(analysis) {
            // Destruir gr√°ficos existentes
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // Colores institucionales de Lomas
            const lomasColors = {
                primary: '#2C7A9B',
                secondary: '#4BA3C7',
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                light: '#87CEEB'
            };
            
            // Gr√°fico de Estados
            const estadosCtx = document.getElementById('estadosChart');
            if (estadosCtx) {
                charts.estados = new Chart(estadosCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Exitosos (201)', 'Error', 'En Cola'],
                        datasets: [{
                            data: [analysis.exitosos, analysis.conError, analysis.enCola],
                            backgroundColor: [lomasColors.success, lomasColors.error, lomasColors.warning],
                            borderWidth: 3,
                            borderColor: '#ffffff',
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    color: lomasColors.primary
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de C√≥digos de Error
            const codigosCtx = document.getElementById('codigosChart');
            if (codigosCtx && Object.keys(analysis.codigosError).length > 0) {
                const labels = Object.keys(analysis.codigosError);
                const data = Object.values(analysis.codigosError);
                
                charts.codigos = new Chart(codigosCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [lomasColors.warning, lomasColors.error, lomasColors.primary],
                            borderRadius: 10,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: lomasColors.primary
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: '#E6F3FF' },
                                ticks: { color: lomasColors.primary }
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { color: lomasColors.primary }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Instancias
            const instanciasCtx = document.getElementById('instanciasChart');
            if (instanciasCtx && Object.keys(analysis.instancias).length > 0) {
                const labels = Object.keys(analysis.instancias);
                const data = Object.values(analysis.instancias);
                
                charts.instancias = new Chart(instanciasCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [lomasColors.primary, lomasColors.secondary, lomasColors.light],
                            borderRadius: 10,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: lomasColors.primary
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: '#E6F3FF' },
                                ticks: { color: lomasColors.primary }
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { color: lomasColors.primary }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico Temporal Total
            const temporalCtx = document.getElementById('temporalChart');
            if (temporalCtx && Object.keys(analysis.temporal).length > 0) {
                const labels = Object.keys(analysis.temporal).sort();
                const data = labels.map(label => analysis.temporal[label]);
                
                charts.temporal = new Chart(temporalCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Mensajes por 15 min (Total)',
                            data: data,
                            borderColor: lomasColors.primary,
                            backgroundColor: lomasColors.primary + '20',
                            borderWidth: 4,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: lomasColors.primary,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 3,
                            pointRadius: 8,
                            pointHoverRadius: 12
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: lomasColors.primary
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: '#E6F3FF' },
                                ticks: { color: lomasColors.primary }
                            },
                            x: { 
                                grid: { color: '#E6F3FF' },
                                ticks: { color: lomasColors.primary }
                            }
                        }
                    }
                });
            }
            
            // Gr√°ficos Temporales por Instancia (√öNICO de instancias)
            const instanciasUnicas = Object.keys(analysis.instancias).filter(inst => inst && inst !== 'null').sort();
            const instanciaColors = [lomasColors.primary, lomasColors.secondary, lomasColors.light, '#ec4899', '#f59e0b', '#8b5cf6'];
            
            instanciasUnicas.forEach((instancia, index) => {
                const canvasId = `temporal_${instancia}`;
                const ctx = document.getElementById(canvasId);
                
                if (ctx && analysis.temporalPorInstancia[instancia]) {
                    const temporalData = analysis.temporalPorInstancia[instancia];
                    const labels = Object.keys(temporalData).sort();
                    const data = labels.map(label => temporalData[label]);
                    
                    const colorIndex = index % instanciaColors.length;
                    const color = instanciaColors[colorIndex];
                    
                    charts[`temporal_${instancia}`] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `${instancia} - Mensajes por 15 min`,
                                data: data,
                                borderColor: color,
                                backgroundColor: color + '20',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: color,
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        color: lomasColors.primary,
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: color,
                                    callbacks: {
                                        title: function(context) {
                                            return `${instancia} - ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            return `${context.parsed.y} mensajes`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    grid: { color: '#E6F3FF' },
                                    ticks: { 
                                        color: lomasColors.primary,
                                        font: { size: 11 }
                                    }
                                },
                                x: { 
                                    grid: { color: '#E6F3FF' },
                                    ticks: { 
                                        color: lomasColors.primary,
                                        font: { size: 11 },
                                        maxTicksLimit: 8
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }
        
        function showLoading() {
            document.getElementById('dashboard').innerHTML = `
                <div class="card loading" style="grid-column: 1 / -1;">
                    <div class="spinner"></div>
                    <div>Conectando con Google Sheets...</div>
                </div>
            `;
        }
        
        function showError(message) {
            document.getElementById('dashboard').innerHTML = `
                <div class="error">
                    <div class="alert-content">
                        <span class="alert-icon">‚ùå</span>
                        <div>
                            <strong>Error al conectar con Google Sheets</strong><br>
                            ${message}<br><br>
                            <strong>Verificar:</strong><br>
                            ‚Ä¢ La hoja "Estado_envios" existe en el documento<br>
                            ‚Ä¢ El documento est√° compartido p√∫blicamente<br>
                            ‚Ä¢ La URL del documento es correcta
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('es-AR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const updateTimeElements = document.querySelectorAll('#updateTime, .update-time');
            updateTimeElements.forEach(element => {
                if (element.id === 'updateTime') {
                    element.textContent = `√öltima actualizaci√≥n: ${timeString}`;
                }
            });
        }
        
        // Cargar datos al inicializar
        window.addEventListener('load', loadData);
        
        // Auto-refresh cada 30 segundos
        setInterval(loadData, 30000);
    </script>
</body>
</html>